<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="../dist/firera.js"></script>
        <script src="jquery.js"></script>
        <style>
            .grid {
                border-left: 1px dotted black;
                padding: 0px 1em;
            }
            .cell {
				padding: 3px 1em;
				border-top: 1px solid grey;
				clear: left;
            }
			
			body {
					font-size: 12px;
					font-family: courier;
			}
			
			h1 {
					font-family: courier;
					text-align: center;
					font-weight: normal;
			}
			
			h2 {
				margin-left: -13px;
				background-color: black;
				color: white;
				padding: 5px 20px;
			}
			
			
			[data-type] h3 {
				float: right;
				margin: 0px;
				padding: 0px 10px;
				/* color: white; */
				text-transform: uppercase;
				/* font-family: sans-serif; */
				font-weight: normal;
				background-color: white;
				color: black;
				font-size: 16px;
				margin-top: -10px;
				border: 1px solid #cacaca;
			}
			
			
			[data-type] {
					border: 7px solid white;
			}
			
			[data-type=system] {
					border-left-color: #cccccc;
			}
			[data-type=children] {
					border-left-color: #fd380c;
			}
			[data-type=formula] {
					border-left-color: #089bf1;
			}
			[data-type=funnel] {
					border-left-color: #912ffd;
			}
			[data-type=free] {
					border-left-color: white;
			}
			[data-type=linked] {
					border-left-color: #ffff9d;
			}
			[data-type=DOM] {
					border-left-color: #ff8d00;
			}
			
			.obj {
				display: inline-block;
				margin-left: -2em;
			}
			
			.cellname {   
				text-align: right;
				float: left;
				color: #99189a;
				font-weight: bold;
			}
			
			.level {
				padding-left: 2em;
			}
			
			.close, .open {    
				border: 5px solid white;
				width: 0px;
				height: 0px;
				display: inline-block;
				cursor: pointer;
			}
			.open {    
				border-left: 5px solid grey;
			}
			.close {    
				border-top: 5px solid grey;
			}
			
			.type {
				padding: 5px;
				color: red;
				text-transform: capitalize;
			}
        </style>
    </head>
    <body>
        <div id="content"></div>
		<script>
				
			var timer = (function(){
				var start = performance.now();
				var pool = [];
				window.timer_results = () => {
						for(let a of pool){
								console.log(a[0], a[1]);
						}
				}
				return (str, force) => {
						var time = performance.now() - start;
						//if(force){
								console.log('str', str, time);
						//}
						pool.push([str, time]);
				}
			})()
			
			var ttimer_pool = {};
			var ttimer = {
					start: function(key){
							if(!ttimer_pool[key]){
									ttimer_pool[key] = {
											sum: 0,
									}
							}
							ttimer_pool[key].current = performance.now();
					},
					stop: function(key){
							ttimer_pool[key].sum += performance.now() - ttimer_pool[key].current;
					},
			}
				
				
			var order_obj = function(order, obj){
					var new_obj = {};
					for(var k of order){
							if(obj[k] !== undefined){
								new_obj[k] = obj[k];
							}
					}
					return new_obj;
			}
			
			var adder = (a) => {
					return (b) => {
							return b + a;
					}
			}
			
			var cell_types_order = ['free', 'linked', 'system', 'formula', 'funnel', 'DOM', 'children'];
			
				var always = (a) => {
				return () => a;
				}
			
			var typf = a => typeof a;
				
			var get_data = (cb, url) => {
				$.get(url, (data) => {
					for(var d of data){
							d.cells = order_obj(cell_types_order, d.cells);
					}
					cb(data);
				})
			}
			
			var grids_from_data = (data) => {
				var res = [];
				for(var key in data){
					res.push(Object.assign({f_name: key}, data[key], {cells: order_obj(cell_types_order, data[key].cells)}));
				}
				return res;
			}
			
			var cell_types_from_data = (data) => {
				var res = [];
				for(var key in data){
					res.push(Object.assign({f_name: key, cells: data[key]}));
				}
				return res;
			}
			
			var prep = Firera.Ozenfant.prepare;
			
			var templates = {
				main: prep(`
						h1 
							"FireraInspector"
						.$grids
				`),
				grid: prep(`
						.grid
							h2.$f_name
							.cell_types$
							.grids$
					`),
				
			}
			
            var app = Firera({
                __root: {
                    url: 'mock.json',
                    $el: $("#content"),
                    $template: templates.main,
                    data: ['async', get_data, 'url'],
                    $child_grids: ['list', {
                        type: 'grid',
                        datasource: ['../data']
                    }],
                },
                grid: {
                    $template: templates.grid,
					r_name: ['$name'],
                    $child_grids: ['list', {
                            type: 'grid',
                            datasource: [grids_from_data, '../children']
                    }],
                    $child_cell_types: ['list', {
                            type: 'cell_type',
                            datasource: [cell_types_from_data, '../cells']
                    }],
                },
				cell_type: {
                    $template: prep(`
						.cell_type(data-type: $f_name)
							h3$f_name
							.$cells
                    `),
					$child_cells: ['list', {
						type: 'cell',
						datasource: ['../cells']
					}]
				},
				cell: {
						$template: prep(`
								.cell
										div.cellname$name
										.obj$
						`),
						$child_obj: [() => {  
								return ['obj_or_scalar', {}, {val: 'val'}]
						}, 'val'],
				},
				obj_or_scalar: {
						$init: {
								isOpened: false,
						},
						$template: prep(`
								.level
										span.name$(font-weight: bold)
										span.type$(font-weight: bold)
										span
												": "
										span.$isObj?
												span.$isOpened?
														span.close(href: #)
																""
														.keys$
												:
														span.open(href: #)
																""
										:
												span.val$
						
						`),
						'isObj': [a => a instanceof Object, 'val'],
						'type': [typf, 'val'],
						'$child_keys': ['list', {
							self: {
								level: ['../level'],
							},
							type: 'obj_or_scalar',
							datasource: [
									(a) => {
											var res = [];
											for(var i in a){
													res.push({name: i, val: a[i]});
											}
											return res;
									}, 
									'../val'],
							create_destroy: ['isOpened']
						}],
						'isOpened': ['funnel', (cell, val) => {
							console.log('clc');
							return cell === '.open|click';
						}, '.open|click', '.close|click'],
				},
				$packages: ['ozenfant', 'htmlCells']
            })
            console.log('app', app);
			setTimeout(() => {
					timer('FINISH', true);
			}, 10)
        </script>
    </body>
</html>
